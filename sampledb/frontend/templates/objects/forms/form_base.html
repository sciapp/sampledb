{% extends "base.html" %}

{% block stylesheets %}
  {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-datetimepicker.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-select.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-tagsinput.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inscrybmde.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jsuites.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jexcel.css') }}" />
{% endblock %}

{% block head_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/jsuites.js') }}"></script>
  <script src="{{ url_for('static', filename='js/jexcel.js') }}"></script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/moment-with-locales.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap-datetimepicker.min.js') }}"></script>
  <!-- <script src="{{ url_for('static', filename='js/bootstrap-select.min.js') }}"></script> -->
  <script src="{{ url_for('static', filename='js/bootstrap-select.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap-tagsinput.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/typeahead.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/inscrybmde.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/markdown_image_upload.js') }}"></script>
{% if config['LOAD_OBJECTS_IN_BACKGROUND'] %}
  <script src="{{ url_for('static', filename='js/sampledb-load-objects.js') }}"></script>
{% endif %}
<script type="text/javascript">
  window.mde_fields = [];

  function updateSelectLanguage(selectpicker) {
    var enabled_languages = $(selectpicker).selectpicker('val');
    if (!Array.isArray(enabled_languages)) {
      return;
    }
    if (enabled_languages === '' || enabled_languages.length === 0) {
      enabled_languages = ['en'];
    } else {
      enabled_languages.push('en');
    }
    var parent_form_group = $(selectpicker).closest('.form-group');
    {% for language in languages %}
      if (enabled_languages.includes("{{ language.lang_code }}")) {
        parent_form_group.find('[data-sampledb-language-input-for="{{ language.lang_code }}"]').show();
      } else {
        parent_form_group.find('[data-sampledb-language-input-for="{{ language.lang_code }}"]').hide();
      }
    {% endfor %}
  }

  function initializeExternalEditors (scope) {
    if (scope.constructor.name != 'HTMLDocument') {
      $('.selectpicker', scope).each (function () {
        var parent = $(this).parent();
        if (parent.hasClass("bootstrap-select")) {
          parent.replaceWith($(this));
        }
        $(this).selectpicker();
      });
    }

    $('.input-group.date:visible', scope).each(function() {
      $(this).datetimepicker({
        locale: "{{ get_user_language(current_user).lang_code }}",
        format: "{{ get_user_language(current_user).datetime_format_moment }}",
        date: $(this).attr('data-datetime')
      });
    });

    $('textarea[data-markdown-textarea="true"]:visible', scope).each(function(_, e) {
      var mde_field = new InscrybMDE({
        element: e,
        indentWithTabs: false,
        spellChecker: false,
        status: false,
        hideIcons: ["guide", "fullscreen", "side-by-side", "quote"],
        showIcons: ["code", "table"],
        minHeight: '100px',
      });
      setupImageDragAndDrop(mde_field);
    });

    var select_language_selectpicker = $('.select-language:visible', scope);
    select_language_selectpicker.on('changed.bs.select', function() {
      updateSelectLanguage(this);
    });
    select_language_selectpicker.each(function(_, selectpicker) {
      updateSelectLanguage(selectpicker);
    });
    $.each(window.conditional_wrapper_scripts, function () {
      this();
    });

    $('div.objectpicker:visible', scope).each(function () {
      let filter_button = $('<button type="button" class="btn btn-default objectpicker-filter-button"  data-toggle="tooltip" data-placement="left" title="{{ _('Filter by Action…') }}"><i class="fa fa-filter"></i></button>');
      $(this).append(filter_button);
      let objectpicker = $(this).find('.selectpicker');
      let actionpicker = $(this).next('.objectpicker-actionpicker').find('.selectpicker');
      filter_button.tooltip();
      filter_button.on('click', function() {
        actionpicker.selectpicker('toggle');
      });
      actionpicker.on('hidden.bs.select', function() {
        let action_id = actionpicker.selectpicker('val');
        if (action_id === "") {
          objectpicker.find('option').prop('disabled', false);
        } else {
          objectpicker.find('option').prop('disabled', true);
          objectpicker.find('option[data-action-id="' + action_id+ '"]').prop('disabled', false);
        }
        objectpicker.find('option[value=""]').prop('disabled', false);
        objectpicker.selectpicker('refresh');
        objectpicker.selectpicker('toggle');
        if (objectpicker.selectpicker('val') === null) {
          objectpicker.selectpicker('val', '');
        }
      });
    });
  }

  $(function () {
    $('textarea.plotly-chart-editor').each(function() {
      var jsonStr = $( this ).text();
      try {
        var jsonObj = JSON.parse(jsonStr);
        var jsonPretty = JSON.stringify(jsonObj, null, '\t');
        $( this ).text(jsonPretty);
      }
      catch (e) {
        return;
      }
    });

    $("div[id$='_spreadsheet']").each(function() {
      var id_prefix = $(this).attr('id').replace(/_spreadsheet$/i, "");
      var data = buildSpreadsheetData(id_prefix);
      window[id_prefix].setData(data);
    });

    initializeExternalEditors(document);
  });

  var tags = new Bloodhound({
    initialize: true,
    local: {{ tags | tojson }},
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
    queryTokenizer: Bloodhound.tokenizers.whitespace
  });
  $('input[name^=\'object__\'][name$=\'__tags\']').each(function() {
    var tagsinput = $(this);
    tagsinput.tagsinput({
      confirmKeys: [13, 32],
      trimValue: true,
      typeaheadjs: {
        name: 'Tags',
        valueKey: 'name',
        displayKey: 'name',
        source: tags.ttAdapter(),
        templates: {
          'suggestion': function(item) {return '<div>' + item.name + ' (×' + item.uses + ')' + '</div>'}
        }
      }
    });
    tagsinput.on('beforeItemAdd', function(event) {
      var sanitized_tag = event.item.toLowerCase().replace(/\s/g,'').replace(/[^a-z0-9_\-äüöß]/g,'');
      if (event.item !== sanitized_tag) {
        if (!event.options || !event.options.fromHandler) {
          event.cancel = true;
          $(this).tagsinput('add', sanitized_tag, {fromHandler: true});
        }
      }
    });
    $(tagsinput.tagsinput('input')).on('blur', function() {
      var item = $(this).tagsinput('input').val();
      $(this).tagsinput('input').val('');
      item = item.trim();
      if (item) {
        $(this).tagsinput('add', item);
      }
    }.bind(tagsinput));
  });

  function getArrayItemCount(prefix) {
    return ($('[id^="'+prefix+'"][class^="array_item"]').length - 1);
  }

  function removeArrayItem(prefix, min, max) {
    var parent_prefix = prefix.substring(0, prefix.length - 3);
    var array_cnt = getArrayItemCount(parent_prefix);
    if (min !== null && array_cnt > min) {
      $('#'+prefix).remove();
    }
    else {
      return false;
    }

    if (min !== null && (array_cnt - 1) <= min) {
      $('button[name^="action_'+parent_prefix+'"][name$="__delete"]').addClass("disabled");
    }
    if (max !== null && (array_cnt - 1) < max) {
      $('button[name="action_'+parent_prefix+'_?__add"]').removeClass("disabled");
    }
    return true;
  }

  function addArrayItem(prefix, min, max) {
    var array_cnt = getArrayItemCount(prefix);
    if (max !== null && array_cnt >= max) {
      return null;
    }
    if (max !== null && (array_cnt + 1) >= max) {
      $('button[name="action_'+prefix+'_?__add"]').addClass("disabled");
    }
    if (min !== null && (array_cnt + 1) > min) {
      $('button[name^="action_'+prefix+'"][name$="__delete"]').removeClass("disabled");
    }

    placeholder_element = $( "#" + prefix + "_placeholder_" );

    var max_id = -1;
    $('[id^="'+prefix+'"]').each( function() {
      var cur_id = $( this ).attr('id').slice(-2, -1);
      if ($( this ).attr('id').length <= (prefix.length + 3)) {
        try {
          cur_id = Number(cur_id);
          max_id = (cur_id > max_id) ? cur_id : max_id;
        }
        catch (e) {
        }
      }
    });

    var content = placeholder_element.clone(false).wrap('<p/>').parent().html();
    var newId = (max_id + 1);
    var re = new RegExp(prefix + '_placeholder_', 'g');

    content = content.replace(re, prefix + '_' + newId + '_');
    content = content.replace('array_item_placeholder', 'array_item_' + newId);
    new_el = $( content ).insertBefore(placeholder_element);
    initializeExternalEditors(new_el);

    return newId;
  }

  function buildSpreadsheetData ( id_prefix ) {
    var data = [];

    for( var r = 0; r < window[(id_prefix + "_row_ref")].length; r++ )
    {
      if (window[(id_prefix + "_row_ref")][r] == "placeholder") { continue; }

      var row = [];
      for( var c = 0; c < window[(id_prefix + "_col_ref")].length; c++ )
      {
        var name = id_prefix + "_" + window[(id_prefix + "_row_ref")][r] + "__" + window[(id_prefix + "_col_ref")][c];

        element = $( '[name='+name+']' ).first();
        if (element.length > 0) {
          var value = element.val();
          if (element.prop("tagName").toLowerCase() == "textarea") {
            value = element.html();
          }
          else if (element.attr('type') == "checkbox") {
            value = element.is(':checked');
          }
          else if (element.parent().hasClass('date')) {
            value = element.parent().attr('data-datetime');
          }
          row.push(value);
        }
        else {
          if (name.endsWith("array") || name.endsWith("object")) {
            row.push("#REF!");
          }
          else {
            row.push(null);
          }
        }
      }
      data.push(row);
    }
    return data;
  }

  function addSpreadsheetRow ( id_prefix, min, max ) {
      var new_id = addArrayItem( id_prefix, min, max );
      if (new_id !== null) {
        window[(id_prefix + "_row_ref")].push(new_id);
        window[id_prefix].setData(buildSpreadsheetData(id_prefix));
      }
  }

</script>
{% endblock %}
