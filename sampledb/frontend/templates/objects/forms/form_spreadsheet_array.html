{% set config = {'unsupported_data_types': ['plotly_chart', 'object', 'array'], 'error': False} %}

<div class="form-group row">
  <div class="col-md-3 control-label">
    {% if schema.title %}<strong><span {% if schema.minItems %}class="required-label"{% endif %}>{{ schema.title | get_translated_text }}</span></strong>{% endif %}
  </div>
</div>

{% if schema['items']['type'] == 'object' %}
  {% set item_property_names = schema["items"].properties.keys() %}
  {% set property_order = schema.get('items', {}).get('propertyOrder', []) %}
  {% set ordered_property_names = [] %}
  {% for property_name in property_order %}
    {% if property_name in item_property_names %}
      ++##{{ schema['items']['properties'][property_name]['type'] }}

      {% do ordered_property_names.append(property_name) %}
    {% endif %}
  {% endfor %}
  {% for property_name in item_property_names %}
    {% if property_name not in property_order %}
      {% do ordered_property_names.append(property_name) %}
    {% endif %}
  {% endfor %}
  <script>
  var col_ref = [];
  var row_ref = {};
  var ref_array = [];

  {% for property_name in ordered_property_names %}
    {% if schema['items']['properties'][property_name]['type'] == 'quantity' %}
      col_ref.push("{{ property_name }}__magnitude");
    {% elif schema['items']['properties'][property_name]['type'] == 'plotly_chart' %}
      col_ref.push("{{ property_name }}__plotly");
    {% elif schema['items']['properties'][property_name]['type'] == 'user' %}
      col_ref.push("{{ property_name }}__uid");
    {% elif schema['items']['properties'][property_name]['type'] in ["object_reference", "measurement", "sample"] %}
      col_ref.push("{{ property_name }}__oid");
    {% else %}
      col_ref.push("{{ property_name }}__{{ schema['items']['properties'][property_name]['type'] }}");
    {% endif %}
  {% endfor %}

  console.log(JSON.stringify(col_ref, null, 2));
  </script>


  <div style="display: none;">
  {% if data is not none %}
    {% for item in data %}
      <script>
      var row = [];
      </script>
      {% set id_prefix = id_prefix + '_{}_'.format(loop.index0) %}
      {% for property_name in ordered_property_names %}
        {% if item is not none and property_name in item %}
          {% set data = item[property_name] %}
          {% set schema = schema['items'].properties[property_name] %}
          {% set z = schema.update({'parent_style': 'table'}) %}
          {% set id_prefix = id_prefix + '_' + property_name + '_' %}
          {% include "objects/forms/form_any.html" %}
        {% endif %}
      {% endfor %}
      <script>
        ref_array.push(row)
      </script>
    {% endfor %}
  {% endif %}
  </div>


  <div style="padding-left:2.5em;" id="spreadsheet"></div>
  <script>
  var data = [];
  for( var r = 0; r < ref_array.length; r++ )
  {
    var row = [];
    for( var c = 0; c < ref_array[r].length; c++ )
    {
      var name = ref_array[r][c];
      input_elements = document.getElementsByName(name);
      if ((typeof input_elements !== 'undefined') && (0 in input_elements)) {
        row.push(document.getElementsByName(name)[0].value.toString())
      }
    }
    data.push(row)
  }

  jspreadsheet(document.getElementById('spreadsheet'), {
      defaultColWidth: {{ (1055 / ordered_property_names|length) | int }},
      columnDrag: false,
      allowInsertColumn: false,
      allowDeleteColumn: false,
      allowRenameColumn: false,
      allowComments: false,
      data:data,
      columns: [
          {% for property_name in ordered_property_names %}
            {
              {% if schema["items"].properties[property_name].type == 'datetime' %}
                type: 'calendar',
                options: { format:'YYYY-MM-DD HH24:MI:SS' },
              {% elif schema["items"].properties[property_name].type == 'quantity' %}
                type: 'number',
                {% if schema["items"].properties[property_name].units == "1" %}
                  mask: '{{ "2220.00" | babel_format_number | replace("2", "#") }}',
                {% else %}
                  mask: '{{ "2220.00" | babel_format_number | replace("2", "#") }} {{ schema["items"].properties[property_name].units }}',
                {% endif %}
              {% else %}
                type: 'text',
              {% endif %}
                title: '{{ schema["items"].properties[property_name].title | get_translated_text }}',
            },
          {% endfor %}
       ],
      updateTable: function(instance, cell, col, row, val, label, cellName) {
        ref_string = ref_array[row][col];
        alert
        if (ref_string) {
          document.getElementsByName(name)[0].value = cell.innerText;
        }
      }

  });
  </script>
{% else %}
  <div class="form-group row has-error">
    <div class="col-md-3 control-label">
      {% if schema.title %}<strong><span {% if schema.minItems %}class="required-label"{% endif %}>{{ schema.title | get_translated_text }}</span></strong>{% endif %}
    </div>
    <div class="col-md-9">
      <span class="help-block"><strong>{{ _('Error:') }}</strong> {{ _('Spreadsheet-View only supports arrays of objects') }}</span>
    </div>
  </div>
{% endif %}

<!--
<div class="form-group row">
  <div class="col-md-3 control-label">
    {% if schema.title %}<strong><span {% if schema.minItems %}class="required-label"{% endif %}>{{ schema.title | get_translated_text }}</span></strong>{% endif %}
  </div>
{% set is_required = False %}
{% set minItems = schema.get('minItems', 0) %}
{% set maxItems = schema.get('maxItems', None) %}
{% if data is not none %}
{% set numItems = (data | length) %}
{% else %}
{% set numItems = 0 %}
{% endif %}
</div>
<div style="padding-left:2.5em;">
  {% if schema['items']['type'] == 'object' %}
  <table class="table">
    <thead>
      <tr>
        {% set item_property_names = schema["items"].properties.keys() %}
        {% set property_order = schema.get('items', {}).get('propertyOrder', []) %}
        {% for property_name in property_order %}
          {% if property_name in item_property_names %}
          <th scope="col">{% if schema["items"].properties[property_name].title %}<span {% if (property_name in schema['items'].get('required', ()) and (schema["items"].properties[property_name].type != "text" or schema["items"].properties[property_name].choices) and schema["items"].properties[property_name].type != "array") or schema["items"].properties[property_name].minLength or schema["items"].properties[property_name].minItems %}class="required-label"{% endif %}>{{ schema["items"].properties[property_name].title | get_translated_text }}</span>{% endif %}</th>
          {% endif %}
        {% endfor %}
        {% for property_name in item_property_names %}
          {% if property_name not in property_order %}
          <th scope="col">{% if schema["items"].properties[property_name].title %}<span {% if (property_name in schema['items'].get('required', ()) and (schema["items"].properties[property_name].type != "text" or schema["items"].properties[property_name].choices) and schema["items"].properties[property_name].type != "array") or schema["items"].properties[property_name].minLength or schema["items"].properties[property_name].minItems %}class="required-label"{% endif %}>{{ schema["items"].properties[property_name].title | get_translated_text }}</span>{% endif %}</th>
          {% endif %}
        {% endfor %}
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% if data is not none %}
      {% for item in data %}
        {% set name = "item" %}
        {% set tmp_style = schema['style'] %}
        {% set schema = schema['items'] %}
        {% set id_prefix = id_prefix + '_{}_'.format(loop.index0) %}
        {% set data = item %}
        <tr>
        {% for property_name in property_order %}
          {% if property_name in item_property_names %}
          <td>
            {% set name = property_name %}
            {% set schema = schema.properties[property_name] %}
            {% set z = schema.update({'parent_style': 'table'}) %}
            {% set id_prefix = id_prefix + '_' + name + '_' %}
            {% if data is not none and property_name in data %}
            {% set data = data[property_name] %}
            {% else %}
            {% set data = none %}
            {% endif %}
            {% include "objects/forms/form_any.html" %}
          </td>
          {% endif %}
        {% endfor %}
        {% for property_name in item_property_names %}
          {% if property_name not in property_order %}
          <td>
            {% set name = property_name %}
            {% set schema = schema.properties[property_name] %}
            {% set z = schema.update({'parent_style': 'table'}) %}
            {% set id_prefix = id_prefix + '_' + name + '_' %}
            {% if data is not none and property_name in data %}
            {% set data = data[property_name] %}
            {% else %}
            {% set data = none %}
            {% endif %}
            {% include "objects/forms/form_any.html" %}
          </td>
          {% endif %}
        {% endfor %}
        {% if numItems > minItems %}
          <td><button type="submit" name="action_{{ id_prefix }}_delete" class="btn btn-danger pull-right">&times;</button></td>
        {% else %}
          <td><button type="button" class="btn btn-danger pull-right disabled">&times;</button></td>
        {% endif %}
        </tr>
      {% endfor %}
    {% endif %}
    </tbody>
    <tfoot>
      <tr>
        {% for property_name in item_property_names %}
          <th scope="col"></th>
        {% endfor %}
  {% if maxItems is none or numItems < maxItems %}
        <th><button type="submit" name="action_{{ id_prefix }}_?__add" class="btn btn-success pull-right">+</button></th>
  {% else %}
        <th><button type="button" class="btn btn-success pull-right disabled">+</button></th>
  {% endif %}
      </tr>
    </tfoot>
  </table>
  {% elif schema['items']['type'] == 'array' %}
  <table class="table">
  {% set max_used_fields = 0 %}
  {% if data is not none %}
    {% set max_used_fields = [0] %}
    {% for item in data %}
      {% if (item | length) > max_used_fields[-1] %}
        {% set tmp = max_used_fields.append(item | length) %}
      {% endif %}
    {% endfor %}
    {% set max_used_fields = max_used_fields [-1] %}
    <thead>
    <tr>
    {% for i in range(max_used_fields) %}
      <th>{{ _('Field %(index)s', index=(i+1)) }}</th>
    {% endfor %}
      <th>
        <div class="btn-group pull-right" role="group" aria-label="Column Controls">
      {% if (data | length) > 0 and max_used_fields > schema["items"].get("minItems", 0) %}
          <button type="submit" name="action_{{ id_prefix }}_?__deletecolumn" class="btn btn-danger"><i class="fa fa-arrow-left"></i></button>
      {% else %}
          <button type="button" class="btn btn-danger disabled"><i class="fa fa-arrow-left"></i></button>
      {% endif %}
      {% if (data | length) > 0 and ("maxItems" not in schema["items"] or max_used_fields < schema["items"]["maxItems"]) %}
          <button type="submit" name="action_{{ id_prefix }}_?__addcolumn" class="btn btn-success"><i class="fa fa-arrow-right"></i></button>
      {% else %}
          <button type="button" class="btn btn-success disabled"><i class="fa fa-arrow-right"></i></button>
      {% endif %}
        </div>
      </th>
    </tr>
    </thead>
    <tbody>
    {% for item in data %}
      {% set item_index = loop.index0 %}
      <tr>
      {% for field in item %}
        <td>
          {% set name = "field_".format(loop.index0) %}
          {% set tmp_style = schema['style'] %}
          {% set schema = schema["items"]["items"] %}
          {% set z = schema.update({'parent_style': 'table'}) %}
          {% set id_prefix = id_prefix + '_{}__{}_'.format(item_index, loop.index0) %}
          {% set data = field %}
          {% include "objects/forms/form_any.html" %}
        </td>
      {% endfor %}
      {% if (item | length) < max_used_fields %}
        {% for i in range((item | length), max_used_fields) %}
        <td>
          {% set name ="field_".format(loop.index0) %}
          {% set tmp_style = schema['style'] %}
          {% set schema = schema["items"]["items"] %}
          {% set z = schema.update({'parent_style': 'table'}) %}
          {% set id_prefix = id_prefix + '_{}__{}_'.format(item_index, i) %}
          {% set data = null %}
          {% include "objects/forms/form_any.html" %}
        </td>{% endfor %}
      {% endif %}
      {% if numItems > minItems %}
        <td><button type="submit" name="action_{{ id_prefix }}_{{ item_index }}__delete" class="btn btn-danger pull-right">&times;</button></td>
      {% else %}
        <td><button type="button" class="btn btn-danger pull-right disabled">&times;</button></td>
      {% endif %}
      </tr>
    {% endfor %}
    </tbody>
  {% endif %}
  <tfoot>
  <tr>
  {% for i in range(max_used_fields) %}
    <th>{{ _('Field %(index)s', index=(i+1)) }}</th>
  {% endfor %}
  {% if maxItems is none or numItems < maxItems %}
        <th><button type="submit" name="action_{{ id_prefix }}_?__add" class="btn btn-success pull-right">+</button></th>
  {% else %}
        <th><button type="button" class="btn btn-success pull-right disabled">+</button></th>
  {% endif %}
  </tr>
  </tfoot>
  </table>
  {% endif %}
</div>
-->
<!-- array end -->
